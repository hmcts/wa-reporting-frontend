#!groovy

@Library("Infrastructure")

def type = "nodejs"
def product = "wa"
def component = "reporting-frontend"

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

env.AUTH_ENABLED="false"

withPipeline(type, product, component) {
  def archiveTestReports = {
    steps.archiveArtifacts(
      allowEmptyArchive: true,
      artifacts: 'test-results/**/*,playwright-report/**/*,functional-output/**/*,smoke-output/**/*'
    )
  }

  afterSuccess('build') {
    yarnBuilder.yarn('playwright install')
    yarnBuilder.yarn('rebuild puppeteer')
    yarnBuilder.yarn('build')
  }

  afterSuccess('test') {
    yarnBuilder.yarn('test:routes')
  }

  afterAlways('test') {
    archiveTestReports()
  }

  afterAlways('smoketest:preview') {
    archiveTestReports()
  }

  afterAlways('smoketest:aat') {
    archiveTestReports()
  }

  afterAlways('functionalTest:preview') {
    archiveTestReports()
  }

  afterAlways('functionalTest:aat') {
    archiveTestReports()
  }
}
