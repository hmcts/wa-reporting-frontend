# Development Guidelines

## Core Principles

### I. Code Quality Is Non-Negotiable

Changes must be maintainable: no new duplication, keep cognitive load flat, idiomatic TypeScript, modular routes, and GOV.UK-compliant UI. Lint, formatting, and type errors block merge; behavior changes require tests. Use existing naming patterns: match file, class, function, and route names to nearby modules; avoid new abbreviations unless already established.

### II. Tests Define Release Readiness

Every feature ships with appropriate unit tests for edge cases and error
paths, route tests for Express endpoints, automated accessibility coverage (Playwright + AxeUtils), and
smoke tests for unmocked happy paths. Tests act as living documentation for intended behavior.

### III. GOV.UK Experience Consistency

GOV.UK Design System patterns (https://design-system.service.gov.uk) are the preferred option in every flow.
Pages use GOV.UK Frontend macros, typography, spacing tokens, and colour palette;
bespoke styling is only allowed when no pattern exists. Content follows the GOV.UK style guide and
interactive states retain ≥ WCAG AA contrast.

## Active Technologies

- TypeScript on Node.js + Express 5, Nunjucks/express-nunjucks, govuk-frontend components, Plotly for charts, axios for API data fetch, Prisma for database integration.
- Playwright smoke/functional tests with @hmcts/playwright-common (shared Playwright config and helpers).
- GOV.UK Design System using the `govuk-frontend` library; refer to https://design-system.service.gov.uk/ for official documentation and usage.

## Subagents (When Available)

Use subagents to parallelise work that can be done independently, then consolidate findings in the main thread. Good fit examples:

- Broad discovery across multiple areas (e.g., one agent scans `docs/`, another scans `src/main/modules/analytics/`, another scans `src/test/`).
- Multi-file refactors with independent scopes (e.g., controller/service/viewModel updates vs. Nunjucks template changes).
- Test coverage work (e.g., one agent identifies missing tests or coverage gaps, another drafts unit/route/a11y tests).
- Investigations that benefit from parallel tracks (e.g., one agent reproduces or runs tests, another inspects recent specs or config).
- Documentation sync tasks (e.g., one agent updates `docs/`, another updates code/tests to match).
- Verification orchestration (e.g., if CI/tooling allows safe parallel runs, delegate lint/tests/build to separate agents and aggregate results).

For verification after code changes, use subagents by default and run independent checks in parallel:

- Spawn one subagent each for `yarn lint`, `yarn test:coverage`, `yarn test:routes`, and `yarn build`.
- Run these checks in parallel unless a concrete dependency requires sequencing.

## Project Structure

```text
docs/
  functional/
  technical/
src/
  main/
    modules/
    routes/
    views/
    assets/
    public/
    resources/
  test/
    unit/
    functional/
    a11y/
    smoke/
    playwright/
      auth/
config/
prisma/
scripts/
```

## Key commands

- `yarn test`
- `yarn test:coverage`
- `yarn test:routes`
- `yarn test:mutation`
- `yarn lint`
- `yarn build`
- Add dependencies with `yarn add` (or `yarn add -D` for dev deps) to ensure the latest versions are pulled in.

## Implementation Guidance

- Analytics pages live under `src/main/modules/analytics/<page>/` with `controller.ts`, `service.ts`, `page.ts`, `viewModel.ts`, and optional `visuals/` for charts/data fetchers. Purpose — `controller.ts`: HTTP entrypoint and route wiring; `service.ts`: data access orchestration; `page.ts`: async composition and fallbacks; `viewModel.ts`: shape data for templates; `visuals/`: chart builders and data fetchers.
- Register new page routes in `src/main/modules/analytics/index.ts` and keep rendering in the page controller (`res.render('analytics/<page>/index')`).
- Nunjucks templates for analytics pages live under `src/main/views/analytics/<page>/index.njk`, with per-page partials in `src/main/views/analytics/<page>/partials/` and shared filters in `src/main/views/analytics/partials/shared-filters.njk`.
- Where Nunjucks macros exist, they should be preferred over pure HTML.
- Shared analytics helpers belong in `src/main/modules/analytics/shared/` (filters, services, viewModels, charts, cache, repositories); reuse before adding new helpers.
- Before researching or planning a change, review the relevant `docs/` specifications and use them as the starting point for understanding current behavior, data flows, and constraints.
- When changing code or behavior, update the corresponding `docs/` files to keep the specifications in sync with the implementation.
- For AJAX section refreshes (e.g., user overview sorting), follow the established pattern: add a `data-section` wrapper around the section partial, submit `ajaxSection` with `X-Requested-With: fetch`, render the specific partial in the controller when the header/section is present, and send URL-encoded form data (including `_csrf`) so `csurf` can validate it.
- Add or update tests under `src/test/` following existing unit/functional/a11y/smoke patterns for the change. Branch and line coverage per file should be at least 95%.
- For changes in mutation-sensitive analytics logic (for example `shared/` helpers, analytics aggregations, repository filter/query composition, and view-model calculations), run focused mutation testing during development using `yarn test:mutation --mutate <source-file>` and, when helpful, `--testFiles <matching-test-file>` to validate the changed unit tests kill mutants in that area.
- Mandatory for non-documentation changes: the final step after any code/config/runtime SQL change is to run `yarn lint`, `yarn test:coverage`, `yarn test:routes` and `yarn build`; do not consider work complete unless all four pass and coverage for files modified as part of the task is above the mandated 95%.
- Documentation-only exception: when all changed files are documentation files (for example `*.md` under repo root or `docs/`) and no executable code, configuration, SQL, assets, or tests are changed, the four mandatory verification commands are not required.
- Any changes which impact these Development Guidelines should be accompanied with changes to the Development Guidelines.

# ExecPlans

When writing complex features or significant refactors, use an ExecPlan (as described in PLANS.md) from design to implementation.

## Repo Skills

This repository includes reusable Codex skills under `skills/`.

### Available skills

- `yarn-dependency-upgrades`: Upgrade dependencies with Yarn 4 for single, multiple, all-package, and CVE-driven flows. Includes precedence-based remediation for `yarn-audit-known-issues` findings and resolution fallback guidance. (file: `skills/yarn-dependency-upgrades/SKILL.md`)
