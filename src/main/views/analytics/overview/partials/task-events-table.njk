{% from "macros/csrf.njk" import csrfProtection %}
{% from "moj/components/date-picker/macro.njk" import mojDatePicker %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "macros/analytics-table.njk" import analyticsTable %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "macros/csv-download.njk" import csvDownloadButton %}

<h2 class="govuk-heading-m govuk-!-margin-top-6">Created, completed and cancelled tasks by service</h2>
<form method="post" class="govuk-!-margin-bottom-4" data-analytics-filters="true" data-ajax-section="overview-task-events">
  {{ csrfProtection(csrfToken) }}
  {% if filters.service %}
    {% for value in filters.service %}
      <input type="hidden" name="service" value="{{ value }}">
    {% endfor %}
  {% endif %}
  {% if filters.roleCategory %}
    {% for value in filters.roleCategory %}
      <input type="hidden" name="roleCategory" value="{{ value }}">
    {% endfor %}
  {% endif %}
  {% if filters.region %}
    {% for value in filters.region %}
      <input type="hidden" name="region" value="{{ value }}">
    {% endfor %}
  {% endif %}
  {% if filters.location %}
    {% for value in filters.location %}
      <input type="hidden" name="location" value="{{ value }}">
    {% endfor %}
  {% endif %}
  {% if filters.taskName %}
    {% for value in filters.taskName %}
      <input type="hidden" name="taskName" value="{{ value }}">
    {% endfor %}
  {% endif %}
  {% if filters.user %}
    {% for value in filters.user %}
      <input type="hidden" name="user" value="{{ value }}">
    {% endfor %}
  {% endif %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-one-third">
      {{ mojDatePicker({
        id: "eventsFrom",
        name: "eventsFrom",
        classes: "govuk-input--width-10",
        label: { text: "Date range from", classes: "govuk-label--s" },
        value: eventsFromValue | default("")
      }) }}
    </div>
    <div class="govuk-grid-column-one-third">
      {{ mojDatePicker({
        id: "eventsTo",
        name: "eventsTo",
        classes: "govuk-input--width-10",
        label: { text: "Date range to", classes: "govuk-label--s" },
        value: eventsToValue | default("")
      }) }}
    </div>
  </div>
  {{ govukButton({
    text: "Apply",
    classes: "govuk-!-margin-top-2"
  }) }}
</form>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-half">
    {% set taskEventsTableHtml %}
      <div class="analytics-tab-panel">
        {{ csvDownloadButton() }}
        {{ analyticsTable({
          attributes: {
            'data-export-csv': 'true',
            'data-export-filename': 'overview-task-events.csv',
            'data-module': 'moj-sortable-table',
            'data-sticky-totals': 'true'
          },
          classes: "analytics-table--compact",
          hasTotals: true,
          head: [
            { text: "Service", attributes: { 'aria-sort': 'ascending' } },
            { text: "Created", format: "numeric", attributes: { 'aria-sort': 'none' } },
            { text: "Completed", format: "numeric", attributes: { 'aria-sort': 'none' } },
            { text: "Cancelled", format: "numeric", attributes: { 'aria-sort': 'none' } }
          ],
          rows: taskEventsRows.concat([taskEventsTotalsRow])
        }) }}
      </div>
    {% endset %}
    {{ govukTabs({
      id: "taskEventsTabs",
      items: [
        { label: "Data table", id: "taskEventsTable", panel: { html: taskEventsTableHtml } }
      ]
    }) }}
  </div>
</div>
