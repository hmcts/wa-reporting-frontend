{% from "macros/csrf.njk" import csrfProtection %}
{% from "govuk/components/date-input/macro.njk" import govukDateInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "macros/analytics-table.njk" import analyticsTable %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "macros/csv-download.njk" import csvDownloadButton %}

<div data-section="overview-task-events">
  <h2 class="govuk-heading-m govuk-!-margin-top-6">Created, completed and cancelled tasks by service</h2>
  <form method="post" class="govuk-!-margin-bottom-4" data-analytics-filters="true" data-ajax-section="overview-task-events">
  {{ csrfProtection(csrfToken) }}
  {% if filters.service %}
    {% for value in filters.service %}
      <input type="hidden" name="service" value="{{ value }}">
    {% endfor %}
  {% endif %}
  {% if filters.roleCategory %}
    {% for value in filters.roleCategory %}
      <input type="hidden" name="roleCategory" value="{{ value }}">
    {% endfor %}
  {% endif %}
  {% if filters.region %}
    {% for value in filters.region %}
      <input type="hidden" name="region" value="{{ value }}">
    {% endfor %}
  {% endif %}
  {% if filters.location %}
    {% for value in filters.location %}
      <input type="hidden" name="location" value="{{ value }}">
    {% endfor %}
  {% endif %}
  {% if filters.taskName %}
    {% for value in filters.taskName %}
      <input type="hidden" name="taskName" value="{{ value }}">
    {% endfor %}
  {% endif %}
  {% if filters.user %}
    {% for value in filters.user %}
      <input type="hidden" name="user" value="{{ value }}">
    {% endfor %}
  {% endif %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-one-third">
      {{ govukDateInput({
        id: "eventsFrom",
        namePrefix: "eventsFrom",
        fieldset: {
          legend: {
            text: "Date range from",
            isPageHeading: false,
            classes: "govuk-fieldset__legend--s"
          }
        },
        items: [
          { name: "day", classes: "govuk-input--width-2", value: eventsFrom.day },
          { name: "month", classes: "govuk-input--width-2", value: eventsFrom.month },
          { name: "year", classes: "govuk-input--width-4", value: eventsFrom.year }
        ]
      }) }}
    </div>
    <div class="govuk-grid-column-one-third">
      {{ govukDateInput({
        id: "eventsTo",
        namePrefix: "eventsTo",
        fieldset: {
          legend: {
            text: "Date range to",
            isPageHeading: false,
            classes: "govuk-fieldset__legend--s"
          }
        },
        items: [
          { name: "day", classes: "govuk-input--width-2", value: eventsTo.day },
          { name: "month", classes: "govuk-input--width-2", value: eventsTo.month },
          { name: "year", classes: "govuk-input--width-4", value: eventsTo.year }
        ]
      }) }}
    </div>
  </div>
  {{ govukButton({
    text: "Apply",
    classes: "govuk-!-margin-top-2"
  }) }}
  </form>

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-one-half">
      {% set taskEventsTableHtml %}
        <div class="analytics-tab-panel">
          {{ csvDownloadButton() }}
          {{ analyticsTable({
            attributes: { 'data-export-csv': 'true', 'data-export-filename': 'overview-task-events.csv', 'data-sortable': 'true' },
            classes: "analytics-table--compact",
            hasTotals: true,
            head: [
              { text: "Service" },
              { text: "Created", format: "numeric" },
              { text: "Completed", format: "numeric" },
              { text: "Cancelled", format: "numeric" }
            ],
            rows: taskEventsRows.concat([taskEventsTotalsRow])
          }) }}
        </div>
      {% endset %}
      {{ govukTabs({
        id: "taskEventsTabs",
        items: [
          { label: "Data table", id: "taskEventsTable", panel: { html: taskEventsTableHtml } }
        ]
      }) }}
    </div>
  </div>
</div>
